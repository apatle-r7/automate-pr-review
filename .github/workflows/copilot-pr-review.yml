name: PR Automation

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  build:
    name: Build & Test
    runs-on: ubuntu-latest
    outputs:
      build_status: ${{ steps.build.outcome }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Make Maven wrapper executable
        run: chmod +x ./mvnw

      - name: Build with Maven
        id: build
        run: ./mvnw clean compile test

      - name: Package application
        run: ./mvnw package -DskipTests

  analyze-impact:
    name: Analyze PR Impact
    runs-on: ubuntu-latest
    needs: build
    outputs:
      impact_level: ${{ steps.analyze.outputs.impact_level }}
      auto_merge: ${{ steps.analyze.outputs.auto_merge }}
      change_summary: ${{ steps.analyze.outputs.change_summary }}
      is_renovate: ${{ steps.analyze.outputs.is_renovate }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get Changed Files
        id: changed-files
        uses: tj-actions/changed-files@v44

      - name: Analyze Changes
        id: analyze
        env:
          ALL_CHANGED_FILES: ${{ steps.changed-files.outputs.all_changed_files }}
          ADDED_FILES: ${{ steps.changed-files.outputs.added_files }}
          MODIFIED_FILES: ${{ steps.changed-files.outputs.modified_files }}
          DELETED_FILES: ${{ steps.changed-files.outputs.deleted_files }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
        run: |
          echo "ğŸ” Analyzing PR impact..."
          
          # Initialize counters
          JAVA_SOURCE=0
          JAVA_TEST=0
          POM_FILES=0
          CONFIG_FILES=0
          DOC_FILES=0
          OTHER_FILES=0
          TOTAL_LINES_ADDED=0
          TOTAL_LINES_DELETED=0
          
          # Count file types
          for file in $ALL_CHANGED_FILES; do
            case "$file" in
              *src/main/java/*.java)
                JAVA_SOURCE=$((JAVA_SOURCE + 1))
                ;;
              *src/test/java/*.java|*Test.java|*Tests.java)
                JAVA_TEST=$((JAVA_TEST + 1))
                ;;
              pom.xml|*/pom.xml)
                POM_FILES=$((POM_FILES + 1))
                ;;
              *.yml|*.yaml|*.properties|*.xml|*.json)
                CONFIG_FILES=$((CONFIG_FILES + 1))
                ;;
              *.md|*.txt|*.adoc|LICENSE|README*)
                DOC_FILES=$((DOC_FILES + 1))
                ;;
              *)
                OTHER_FILES=$((OTHER_FILES + 1))
                ;;
            esac
          done
          
          # Get lines changed
          TOTAL_LINES_ADDED=$(git diff origin/main...HEAD --numstat | awk '{sum+=$1} END {print sum+0}')
          TOTAL_LINES_DELETED=$(git diff origin/main...HEAD --numstat | awk '{sum+=$2} END {print sum+0}')
          TOTAL_LINES=$((TOTAL_LINES_ADDED + TOTAL_LINES_DELETED))
          
          echo "ğŸ“Š Change Analysis:"
          echo "  Java source files: $JAVA_SOURCE"
          echo "  Java test files: $JAVA_TEST"
          echo "  POM files: $POM_FILES"
          echo "  Config files: $CONFIG_FILES"
          echo "  Documentation files: $DOC_FILES"
          echo "  Other files: $OTHER_FILES"
          echo "  Lines added: $TOTAL_LINES_ADDED"
          echo "  Lines deleted: $TOTAL_LINES_DELETED"
          echo "  Total lines changed: $TOTAL_LINES"
          
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # ENHANCED IMPACT CLASSIFICATION LOGIC
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          # Configuration thresholds (easily adjustable)
          CRITICAL_JAVA_FILES=10
          CRITICAL_TOTAL_LINES=500
          MAJOR_JAVA_FILES=4
          MAJOR_TOTAL_LINES=200
          MINOR_JAVA_FILES=0
          MINOR_TOTAL_LINES=50
          
          echo "ğŸ“‹ Thresholds:"
          echo "  Critical: >$CRITICAL_JAVA_FILES files or >$CRITICAL_TOTAL_LINES lines"
          echo "  Major: >$MAJOR_JAVA_FILES files or >$MAJOR_TOTAL_LINES lines"
          echo "  Minor: >$MINOR_JAVA_FILES files or >$MINOR_TOTAL_LINES lines"
          
          # Check for critical files
          CRITICAL_FILES=false
          for file in $ALL_CHANGED_FILES; do
            case "$file" in
              *Security*.java|*Auth*.java|*Password*.java|*Credential*.java)
                CRITICAL_FILES=true
                echo "ğŸš¨ Critical file detected: $file"
                ;;
              *application-prod.yml|*application-prod.properties)
                CRITICAL_FILES=true
                echo "ğŸš¨ Critical file detected: $file"
                ;;
            esac
          done
          
          # Set defaults
          IMPACT="TRIVIAL"
          AUTO_MERGE="true"
          EMOJI="ğŸŸ¢"
          
          # Evaluate impact with clear precedence
          if [[ "$CRITICAL_FILES" == "true" ]] || [[ $JAVA_SOURCE -gt $CRITICAL_JAVA_FILES ]] || [[ $TOTAL_LINES -gt $CRITICAL_TOTAL_LINES ]]; then
            IMPACT="CRITICAL"
            AUTO_MERGE="false"
            EMOJI="ğŸ”´"
          elif [[ $JAVA_SOURCE -gt $MAJOR_JAVA_FILES ]] || [[ $TOTAL_LINES -gt $MAJOR_TOTAL_LINES ]]; then
            IMPACT="MAJOR"
            AUTO_MERGE="false"
            EMOJI="ğŸŸ "
          elif [[ $JAVA_SOURCE -gt $MINOR_JAVA_FILES ]] || [[ $TOTAL_LINES -gt $MINOR_TOTAL_LINES ]]; then
            IMPACT="MINOR"
            AUTO_MERGE="false"
            EMOJI="ğŸŸ¡"
          fi
          
          # Log impact decision for debugging
          echo "âœ“ Impact Assessment: $IMPACT | Java Files: $JAVA_SOURCE | Total Lines: $TOTAL_LINES | Auto-merge: $AUTO_MERGE"
          
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # RENOVATE INTEGRATION
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          IS_RENOVATE="false"
          if [[ "$PR_AUTHOR" == "renovate[bot]" ]] || [[ "$PR_AUTHOR" == "renovate" ]]; then
            IS_RENOVATE="true"
            echo "ğŸ¤– Renovate PR detected from: $PR_AUTHOR"
            
            TOTAL_FILES=$((JAVA_SOURCE + JAVA_TEST + POM_FILES + CONFIG_FILES + DOC_FILES + OTHER_FILES))
            
            # Renovate with only POM changes - Safe to auto-merge
            if [[ $POM_FILES -gt 0 ]] && [[ $JAVA_SOURCE -eq 0 ]] && [[ $JAVA_TEST -eq 0 ]]; then
              echo "âœ… Renovate: Dependency update (POM-only changes)"
              IMPACT="TRIVIAL"
              AUTO_MERGE="true"
              EMOJI="ğŸŸ¢"
            # Renovate with non-POM changes - Requires review
            elif [[ $JAVA_SOURCE -gt 0 ]] || [[ $JAVA_TEST -gt 0 ]] || [[ $CONFIG_FILES -gt 2 ]]; then
              echo "âš ï¸ Renovate: Multiple component changes - review recommended"
              IMPACT="MAJOR"
              AUTO_MERGE="false"
              EMOJI="ğŸŸ "
            # Renovate with config changes only
            elif [[ $CONFIG_FILES -gt 0 ]]; then
              echo "âœ… Renovate: Config-only update"
              IMPACT="MINOR"
              AUTO_MERGE="false"
              EMOJI="ğŸŸ¡"
            fi
          fi
          
          # Create summary
          SUMMARY="Java:$JAVA_SOURCE Test:$JAVA_TEST POM:$POM_FILES Config:$CONFIG_FILES Docs:$DOC_FILES Lines:$TOTAL_LINES"
          
          # Set outputs
          echo "impact_level=$IMPACT" >> $GITHUB_OUTPUT
          echo "auto_merge=$AUTO_MERGE" >> $GITHUB_OUTPUT
          echo "change_summary=$SUMMARY" >> $GITHUB_OUTPUT
          echo "is_renovate=$IS_RENOVATE" >> $GITHUB_OUTPUT
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "$EMOJI Impact: $IMPACT"
          echo "   Auto-merge: $AUTO_MERGE"
          echo "   Renovate: $IS_RENOVATE"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

  post-review:
    name: Post Review Comment
    runs-on: ubuntu-latest
    needs: [build, analyze-impact]

    steps:
      - name: Post Impact Analysis Comment
        uses: actions/github-script@v7
        env:
          IMPACT: ${{ needs.analyze-impact.outputs.impact_level }}
          AUTO_MERGE: ${{ needs.analyze-impact.outputs.auto_merge }}
          SUMMARY: ${{ needs.analyze-impact.outputs.change_summary }}
          IS_RENOVATE: ${{ needs.analyze-impact.outputs.is_renovate }}
          BUILD_STATUS: ${{ needs.build.outputs.build_status }}
        with:
          script: |
            const impact = process.env.IMPACT;
            const autoMerge = process.env.AUTO_MERGE === 'true';
            const summary = process.env.SUMMARY;
            const isRenovate = process.env.IS_RENOVATE === 'true';
            const buildStatus = process.env.BUILD_STATUS || 'success';
            
            const impactConfig = {
              'CRITICAL': { emoji: 'ğŸ”´', title: 'Critical Impact', color: 'red' },
              'MAJOR': { emoji: 'ğŸŸ ', title: 'Major Impact', color: 'orange' },
              'MINOR': { emoji: 'ğŸŸ¡', title: 'Minor Impact', color: 'yellow' },
              'TRIVIAL': { emoji: 'ğŸŸ¢', title: 'Trivial Impact', color: 'green' }
            };
            
            const config = impactConfig[impact] || impactConfig['MINOR'];
            
            let recommendation;
            let renovateNote = '';
            
            if (isRenovate) {
              renovateNote = '\nğŸ“¦ **Renovate Dependency Update**\n';
            }
            
            switch(impact) {
              case 'CRITICAL':
                recommendation = 'ğŸš¨ **Critical changes detected!** Senior developer review required. Security-sensitive or large-scale changes.';
                break;
              case 'MAJOR':
                recommendation = isRenovate 
                  ? 'âš ï¸ **Major dependency update detected.** Review version compatibility and breaking changes before merging.'
                  : 'âš ï¸ **Major changes detected.** Thorough code review recommended before merging.';
                break;
              case 'MINOR':
                recommendation = isRenovate
                  ? 'ğŸ‘€ **Minor dependency update.** Standard review recommended.'
                  : 'ğŸ‘€ **Minor changes.** Standard code review recommended.';
                break;
              case 'TRIVIAL':
                recommendation = isRenovate
                  ? 'âœ… **Renovate patch/minor update.** Safe for auto-merge after build passes.'
                  : 'âœ… **Trivial changes.** Safe for auto-merge after build passes.';
                break;
            }
            
            const body = `## ${config.emoji} PR Impact Analysis: ${config.title}
            ${renovateNote}
            
            ### ğŸ“Š Build Status
            | Check | Status |
            |-------|--------|
            | Build & Test | ${buildStatus === 'success' ? 'âœ… Passed' : 'âŒ Failed'} |
            
            ### ğŸ“ Change Summary
            \`${summary}\`
            
            ### ğŸ¯ Impact Assessment
            | Criteria | Value |
            |----------|-------|
            | **Impact Level** | ${config.emoji} ${impact} |
            | **Auto-merge Eligible** | ${autoMerge ? 'âœ… Yes' : 'âŒ No'} |
            | **PR Type** | ${isRenovate ? 'ğŸ¤– Renovate' : 'ğŸ‘¤ Manual'} |
            
            ### ğŸ’¡ Recommendation
            ${recommendation}
            
            ---
            
            <details>
            <summary>ğŸ“– Impact Classification Guide</summary>
            
            | Level | Criteria | Action |
            |-------|----------|--------|
            | ğŸŸ¢ TRIVIAL | Docs, tests only, <50 lines | Auto-merge |
            | ğŸŸ¡ MINOR | 1-4 Java files, 50-200 lines | Review recommended |
            | ğŸŸ  MAJOR | 5-10 Java files, 200-500 lines | Review required |
            | ğŸ”´ CRITICAL | >10 files, >500 lines, security files | Senior review required |
            
            **Renovate Special Handling:**
            - âœ… POM-only: Auto-merge if build passes
            - ğŸŸ¡ Config-only: Minor impact, review recommended
            - ğŸŸ  Mixed changes: Major impact, thorough review needed
            
            </details>
            
            ---
            *ğŸ¤– Automated analysis by PR Automation*`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

  auto-merge:
    name: Auto Merge (Trivial Changes)
    runs-on: ubuntu-latest
    needs: [build, analyze-impact]
    if: |
      needs.analyze-impact.outputs.auto_merge == 'true' && 
      needs.build.result == 'success'

    steps:
      - name: Approve PR
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              event: 'APPROVE',
              body: 'âœ… **Auto-approved:** Trivial changes detected. All checks passed.'
            });
            console.log('âœ… PR approved');

      - name: Merge PR
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.pulls.merge({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              merge_method: 'squash',
              commit_title: `Auto-merge: ${context.payload.pull_request.title}`,
              commit_message: 'Automatically merged - trivial changes with passing checks.'
            });
            console.log('ğŸ‰ PR merged');

  add-labels:
    name: Add Labels
    runs-on: ubuntu-latest
    needs: analyze-impact

    steps:
      - name: Add Impact and Renovate Labels
        uses: actions/github-script@v7
        with:
          script: |
            const impact = '${{ needs.analyze-impact.outputs.impact_level }}';
            const isRenovate = '${{ needs.analyze-impact.outputs.is_renovate }}' === 'true';
            
            const labelMap = {
              'CRITICAL': 'impact-critical',
              'MAJOR': 'impact-major',
              'MINOR': 'impact-minor',
              'TRIVIAL': 'impact-trivial'
            };
            
            const labels = [labelMap[impact] || 'needs-review'];
            
            if (isRenovate) {
              labels.push('dependencies');
              labels.push('renovate');
            }
            
            try {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: labels
              });
              console.log(`âœ… Added labels: ${labels.join(', ')}`);
            } catch (error) {
              console.log('Some labels may not exist');
            }