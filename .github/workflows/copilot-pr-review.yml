name: PR Automation
on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  build:
    name: build
    runs-on: ubuntu-latest
    outputs:
      build_status: ${{ job.status }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven
      - name: Build with Maven
        run: ./mvnw clean compile test
      - name: Package application
        run: ./mvnw package -DskipTests

  auto-rules:
    name: Auto-Rules Detection
    runs-on: ubuntu-latest
    needs: build
    if: success() && github.event_name == 'pull_request'
    outputs:
      rule_set: ${{ steps.detect.outputs.rule_set }}
      priority: ${{ steps.detect.outputs.priority }}
      reviewers: ${{ steps.detect.outputs.reviewers }}
      auto_merge: ${{ steps.detect.outputs.auto_merge }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Load Rules Configuration
        id: config
        run: |
          # Load the rules configuration from JSON
          CONFIG=$(cat .github/rules-config.json)
          echo "config=$CONFIG" >> $GITHUB_OUTPUT
          echo "‚úÖ Rules configuration loaded"

      - name: Detect Changed Files
        id: files
        run: |
          # Get changed files
          if [ "${{ github.event.pull_request.base.sha }}" != "" ]; then
            FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }})
          else
            FILES=$(git diff --name-only HEAD~1 HEAD)
          fi
          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          echo "$FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Analyze & Auto-Detect Rules
        id: detect
        env:
          CHANGED_FILES: ${{ steps.files.outputs.changed_files }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_BODY: ${{ github.event.pull_request.body }}
          CONFIG: ${{ steps.config.outputs.config }}
        run: |
          echo "üìä Analyzing PR for automatic rule detection..."
          
          # Initialize counters
          JAVA_FILES=0
          TEST_FILES=0
          CONFIG_FILES=0
          DOC_FILES=0
          TOTAL=0
          
          # Analyze each file
          while IFS= read -r file; do
            [ -z "$file" ] && continue
            TOTAL=$((TOTAL + 1))
            
            case "$file" in
              *.java)
                if [[ "$file" == *"test"* ]] || [[ "$file" == *"Test"* ]]; then
                  TEST_FILES=$((TEST_FILES + 1))
                else
                  JAVA_FILES=$((JAVA_FILES + 1))
                fi
                ;;
              *.yml|*.yaml|*.properties|pom.xml|*/pom.xml|*.xml)
                CONFIG_FILES=$((CONFIG_FILES + 1))
                ;;
              *.md|*.txt|*.adoc|*.rst)
                DOC_FILES=$((DOC_FILES + 1))
                ;;
            esac
          done <<< "$CHANGED_FILES"
          
          # Get thresholds from config
          JAVA_MAJOR=$(echo "$CONFIG" | jq -r '.thresholds.java_files_major')
          JAVA_MINOR=$(echo "$CONFIG" | jq -r '.thresholds.java_files_minor')
          CONFIG_THRESHOLD=$(echo "$CONFIG" | jq -r '.thresholds.config_files_threshold')
          
          echo "üìã Detected Files:"
          echo "  - Java Source: $JAVA_FILES"
          echo "  - Test Files: $TEST_FILES"
          echo "  - Config Files: $CONFIG_FILES"
          echo "  - Doc Files: $DOC_FILES"
          echo "  - Total: $TOTAL"
          
          # Check for manual rule override in PR title
          if [[ "$PR_TITLE" == *"[RULE:MAJOR_CHANGES]"* ]]; then
            RULE="MAJOR_CHANGES"
            echo "üîß Manual override detected: MAJOR_CHANGES"
          elif [[ "$PR_TITLE" == *"[RULE:CONFIG_ONLY]"* ]]; then
            RULE="CONFIG_ONLY"
            echo "üîß Manual override detected: CONFIG_ONLY"
          elif [[ "$PR_TITLE" == *"[RULE:DOCS_AND_TESTS]"* ]]; then
            RULE="DOCS_AND_TESTS"
            echo "üîß Manual override detected: DOCS_AND_TESTS"
          # Auto-detect rule based on file analysis
          elif [[ $JAVA_FILES -gt $JAVA_MAJOR ]]; then
            RULE="MAJOR_CHANGES"
          elif [[ $JAVA_FILES -ge $JAVA_MINOR ]] && [[ $JAVA_FILES -le $JAVA_MAJOR ]]; then
            RULE="MINOR_CHANGES"
          elif [[ $CONFIG_FILES -ge $CONFIG_THRESHOLD ]] && [[ $JAVA_FILES -eq 0 ]]; then
            RULE="CONFIG_ONLY"
          elif [[ $TOTAL -eq $DOC_FILES ]] || [[ $TOTAL -eq $TEST_FILES ]]; then
            RULE="DOCS_AND_TESTS"
          else
            RULE="DEFAULT"
          fi
          
          # Get rule details from config
          PRIORITY=$(echo "$CONFIG" | jq -r ".rules.$RULE.priority")
          REVIEWERS=$(echo "$CONFIG" | jq -r ".rules.$RULE.reviewers | join(\",\")")
          AUTO_MERGE=$(echo "$CONFIG" | jq -r ".rules.$RULE.auto_merge")
          DESCRIPTION=$(echo "$CONFIG" | jq -r ".rules.$RULE.description")
          
          echo ""
          echo "üéØ Auto-Detected Rule: $RULE"
          echo "üìå Priority Level: $PRIORITY"
          echo "üë• Assigned Reviewers: $REVIEWERS"
          echo "‚ôªÔ∏è  Auto-Merge Enabled: $AUTO_MERGE"
          echo "üìù Description: $DESCRIPTION"
          
          echo "rule_set=$RULE" >> $GITHUB_OUTPUT
          echo "priority=$PRIORITY" >> $GITHUB_OUTPUT
          echo "reviewers=$REVIEWERS" >> $GITHUB_OUTPUT
          echo "auto_merge=$AUTO_MERGE" >> $GITHUB_OUTPUT

      - name: Apply Auto-Rules
        uses: actions/github-script@v7
        env:
          RULE_SET: ${{ steps.detect.outputs.rule_set }}
          PRIORITY: ${{ steps.detect.outputs.priority }}
          REVIEWERS: ${{ steps.detect.outputs.reviewers }}
          AUTO_MERGE: ${{ steps.detect.outputs.auto_merge }}
          CONFIG: ${{ steps.config.outputs.config }}
        with:
          script: |
            const ruleSet = process.env.RULE_SET;
            const priority = process.env.PRIORITY;
            const reviewers = process.env.REVIEWERS;
            const autoMerge = process.env.AUTO_MERGE === 'true';
            const config = JSON.parse(process.env.CONFIG);
            
            console.log(`üìã Auto-Rule Applied: ${ruleSet}`);
            console.log(`üéØ Priority: ${priority}`);
            console.log(`üë• Reviewers: ${reviewers}`);
            console.log(`‚ôªÔ∏è  Auto-Merge: ${autoMerge}`);
            
            // Get labels from config
            const labels = config.rules[ruleSet].labels || [config.rules[ruleSet].labels];
            
            try {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: labels
              });
              console.log(`‚úÖ Labels applied: ${labels.join(', ')}`);
            } catch (error) {
              console.log('Could not add labels:', error.message);
            }
            
            // Post comment with auto-detected rules
            const comments = {
              'MAJOR_CHANGES': 'üî¥ **MAJOR CHANGES DETECTED**\nThis PR contains significant code changes. Critical review by senior team members required.',
              'MINOR_CHANGES': 'üü° **MINOR CHANGES DETECTED**\nThis PR contains limited code changes. Team leads should review this PR.',
              'CONFIG_ONLY': '‚öôÔ∏è **CONFIG CHANGES ONLY**\nThis PR modifies only configuration files. DevOps team review recommended.',
              'DOCS_AND_TESTS': 'üü¢ **DOCUMENTATION & TESTS ONLY**\nThis PR contains only documentation or test updates. No functionality review needed.',
              'DEFAULT': 'üìã **DEFAULT RULE APPLIED**\nStandard review process applies to this PR.'
            };
            
            const body = comments[ruleSet] || comments['DEFAULT'];
            const details = '\n\n**Rule Details:**\n' +
              '- Rule Set: ' + ruleSet + '\n' +
              '- Priority: ' + priority + '\n' +
              '- Reviewers: ' + (reviewers || 'None') + '\n' +
              '- Auto-Merge: ' + (autoMerge ? 'Yes ‚úÖ' : 'No ‚ùå') + '\n\n' +
              '*Rules loaded from: .github/rules-config.json*';
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body + details
            });