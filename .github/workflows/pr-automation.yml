name: PR Automation

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  build:
    name: Build & Test
    runs-on: ubuntu-latest
    outputs:
      build_status: ${{ steps.build.outcome }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Make Maven wrapper executable
        run: chmod +x ./mvnw

      - name: Build with Maven
        id: build
        run: ./mvnw clean compile test

      - name: Package application
        run: ./mvnw package -DskipTests

  ensure-labels:
    name: Ensure Impact Labels
    runs-on: ubuntu-latest
    steps:
      - name: Create labels if missing
        uses: actions/github-script@v7
        with:
          script: |
            const labels = [
              { name: 'impact-critical', color: 'd73a49', description: 'High risk changes' },
              { name: 'impact-major', color: 'f66a0a', description: 'Major impact changes' },
              { name: 'impact-minor', color: 'ffd33d', description: 'Minor impact changes' },
              { name: 'impact-trivial', color: '28a745', description: 'Trivial changes' }
            ];

            for (const l of labels) {
              try {
                await github.rest.issues.getLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: l.name
                });
                console.log(`âœ… Label exists: ${l.name}`);
              } catch (e) {
                try {
                  await github.rest.issues.createLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    name: l.name,
                    color: l.color,
                    description: l.description
                  });
                  console.log(`ğŸ†• Created label: ${l.name}`);
                } catch (err) {
                  console.log(`âš ï¸ Could not create label ${l.name}: ${err.message}`);
                }
              }
            }

  analyze-impact:
    name: Analyze PR Impact
    runs-on: ubuntu-latest
    needs: build
    outputs:
      impact_level: ${{ steps.analyze.outputs.impact_level }}
      auto_merge: ${{ steps.analyze.outputs.auto_merge }}
      change_summary: ${{ steps.analyze.outputs.change_summary }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get Changed Files
        id: changed-files
        uses: tj-actions/changed-files@v44

      - name: Analyze Changes
        id: analyze
        env:
          ALL_CHANGED_FILES: ${{ steps.changed-files.outputs.all_changed_files }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
        run: |
          echo "ğŸ” Analyzing PR impact..."
          
          # Initialize counters
          JAVA_SOURCE=0
          JAVA_TEST=0
          POM_FILES=0
          CONFIG_FILES=0
          DOC_FILES=0
          OTHER_FILES=0
          TOTAL_LINES_ADDED=0
          TOTAL_LINES_DELETED=0
          TOTAL_FILES=0
          
          # Count file types
          for file in $ALL_CHANGED_FILES; do
            TOTAL_FILES=$((TOTAL_FILES + 1))
            case "$file" in
              *src/main/java/*.java)
                JAVA_SOURCE=$((JAVA_SOURCE + 1))
                ;;
              *src/test/java/*.java|*Test.java|*Tests.java)
                JAVA_TEST=$((JAVA_TEST + 1))
                ;;
              pom.xml|*/pom.xml)
                POM_FILES=$((POM_FILES + 1))
                ;;
              *.yml|*.yaml|*.properties|*.xml|*.json)
                CONFIG_FILES=$((CONFIG_FILES + 1))
                ;;
              *.md|*.txt|*.adoc|LICENSE|README*)
                DOC_FILES=$((DOC_FILES + 1))
                ;;
              *)
                OTHER_FILES=$((OTHER_FILES + 1))
                ;;
            esac
          done
          
          # Get lines changed
          TOTAL_LINES_ADDED=$(git diff origin/main...HEAD --numstat | awk '{sum+=$1} END {print sum+0}')
          TOTAL_LINES_DELETED=$(git diff origin/main...HEAD --numstat | awk '{sum+=$2} END {print sum+0}')
          TOTAL_LINES=$((TOTAL_LINES_ADDED + TOTAL_LINES_DELETED))
          
          echo "ğŸ“Š Change Analysis:"
          echo "  Java source files: $JAVA_SOURCE"
          echo "  Java test files: $JAVA_TEST"
          echo "  POM files: $POM_FILES"
          echo "  Config files: $CONFIG_FILES"
          echo "  Documentation files: $DOC_FILES"
          echo "  Other files: $OTHER_FILES"
          echo "  Lines added: $TOTAL_LINES_ADDED"
          echo "  Lines deleted: $TOTAL_LINES_DELETED"
          echo "  Total lines changed: $TOTAL_LINES"
          
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # IMPACT CLASSIFICATION LOGIC
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          #
          # POM-ONLY (Auto-merge):
          #   - Only pom.xml files changed, nothing else
          #
          # CRITICAL (Never auto-merge):
          #   - More than 10 Java source files changed
          #   - More than 500 lines changed
          #   - Security/auth files modified
          #   - POM + other files changed together
          #
          # MAJOR (Never auto-merge):
          #   - 5-10 Java source files changed
          #   - 200-500 lines changed
          #   - Core config files modified
          #
          # MINOR (Review recommended):
          #   - 1-4 Java source files changed
          #   - 50-200 lines changed
          #
          # TRIVIAL (Auto-merge eligible):
          #   - Only docs/tests changed
          #   - Less than 50 lines
          #   - Renovate POM-only changes
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          # Check if only POM files changed
          POM_ONLY=false
          if [[ $POM_FILES -gt 0 ]] && [[ $POM_FILES -eq $TOTAL_FILES ]]; then
            POM_ONLY=true
            echo "âœ… POM-only change detected!"
          fi
          
          # Check for critical files
          CRITICAL_FILES=false
          for file in $ALL_CHANGED_FILES; do
            case "$file" in
              *Security*.java|*Auth*.java|*Password*.java|*Credential*.java)
                CRITICAL_FILES=true
                ;;
              *application-prod.yml|*application-prod.properties)
                CRITICAL_FILES=true
                ;;
            esac
          done
          
          # Determine impact level
          if [[ "$POM_ONLY" == "true" ]]; then
            # âœ… ONLY pom.xml changed - safe to auto-merge
            IMPACT="POM_ONLY"
            AUTO_MERGE="true"
            EMOJI="ğŸ“¦"
            echo "âœ… POM-only change - eligible for auto-merge"
          elif [[ $POM_FILES -gt 0 ]] && [[ $TOTAL_FILES -gt $POM_FILES ]]; then
            # âŒ pom.xml + other files changed - requires review
            IMPACT="MAJOR"
            AUTO_MERGE="false"
            EMOJI="ğŸŸ "
            echo "âš ï¸ POM + other files changed - requires manual review"
          elif [[ "$CRITICAL_FILES" == "true" ]] || [[ $JAVA_SOURCE -gt 10 ]] || [[ $TOTAL_LINES -gt 500 ]]; then
            IMPACT="CRITICAL"
            AUTO_MERGE="false"
            EMOJI="ğŸ”´"
          elif [[ $JAVA_SOURCE -gt 4 ]] || [[ $TOTAL_LINES -gt 200 ]]; then
            IMPACT="MAJOR"
            AUTO_MERGE="false"
            EMOJI="ğŸŸ "
          elif [[ $JAVA_SOURCE -gt 0 ]] || [[ $TOTAL_LINES -gt 50 ]]; then
            IMPACT="MINOR"
            AUTO_MERGE="false"
            EMOJI="ğŸŸ¡"
          else
            IMPACT="TRIVIAL"
            AUTO_MERGE="true"
            EMOJI="ğŸŸ¢"
          fi
          
          # Special handling for Renovate bot
          if [[ "$PR_AUTHOR" == "renovate[bot]" ]]; then
            if [[ "$POM_ONLY" == "true" ]]; then
              echo "âœ… Renovate PR with POM-only changes"
              IMPACT="POM_ONLY"
              AUTO_MERGE="true"
              EMOJI="ğŸ“¦"
            else
              echo "âš ï¸ Renovate PR with non-POM changes"
              IMPACT="MAJOR"
              AUTO_MERGE="false"
              EMOJI="ğŸŸ "
            fi
          fi
          
          # Create summary
          SUMMARY="Java:$JAVA_SOURCE Test:$JAVA_TEST POM:$POM_FILES Config:$CONFIG_FILES Docs:$DOC_FILES Lines:$TOTAL_LINES POM-Only:$POM_ONLY"
          
          # Set outputs
          echo "impact_level=$IMPACT" >> $GITHUB_OUTPUT
          echo "auto_merge=$AUTO_MERGE" >> $GITHUB_OUTPUT
          echo "change_summary=$SUMMARY" >> $GITHUB_OUTPUT
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "$EMOJI Impact: $IMPACT"
          echo "   Auto-merge: $AUTO_MERGE"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

  post-review:
    name: Post Review Comment
    runs-on: ubuntu-latest
    needs: [build, analyze-impact]

    steps:
      - name: Post Impact Analysis Comment
        uses: actions/github-script@v7
        env:
          IMPACT: ${{ needs.analyze-impact.outputs.impact_level }}
          AUTO_MERGE: ${{ needs.analyze-impact.outputs.auto_merge }}
          SUMMARY: ${{ needs.analyze-impact.outputs.change_summary }}
          BUILD_STATUS: ${{ needs.build.outputs.build_status }}
        with:
          script: |
            const impact = process.env.IMPACT;
            const autoMerge = process.env.AUTO_MERGE === 'true';
            const summary = process.env.SUMMARY;
            const buildStatus = process.env.BUILD_STATUS || 'success';
            
            const impactConfig = {
              'CRITICAL': { emoji: 'ğŸ”´', title: 'Critical Impact', color: 'red' },
              'MAJOR': { emoji: 'ğŸŸ ', title: 'Major Impact', color: 'orange' },
              'MINOR': { emoji: 'ğŸŸ¡', title: 'Minor Impact', color: 'yellow' },
              'TRIVIAL': { emoji: 'ğŸŸ¢', title: 'Trivial Impact', color: 'green' },
              'POM_ONLY': { emoji: 'ğŸ“¦', title: 'POM Only (Dependency Update)', color: 'green' }
            };
            
            const config = impactConfig[impact] || impactConfig['MINOR'];
            
            let recommendation;
            switch(impact) {
              case 'CRITICAL':
                recommendation = 'ğŸš¨ **Critical changes detected!** Senior developer review required. Security-sensitive or large-scale changes.';
                break;
              case 'MAJOR':
                recommendation = 'âš ï¸ **Major changes detected.** Thorough code review recommended before merging.';
                break;
              case 'MINOR':
                recommendation = 'ğŸ‘€ **Minor changes.** Standard code review recommended.';
                break;
              case 'TRIVIAL':
                recommendation = 'âœ… **Trivial changes.** Safe for auto-merge after build passes.';
                break;
              case 'POM_ONLY':
                recommendation = 'ğŸ“¦ **Dependency update only.** Only pom.xml changed - safe for auto-merge.';
                break;
            }
            
            const body = `## ${config.emoji} PR Impact Analysis: ${config.title}
            
            ### ğŸ“Š Build Status
            | Check | Status |
            |-------|--------|
            | Build & Test | ${buildStatus === 'success' ? 'âœ… Passed' : 'âŒ Failed'} |
            
            ### ğŸ“ Change Summary
            \`${summary}\`
            
            ### ğŸ¯ Impact Assessment
            | Criteria | Value |
            |----------|-------|
            | **Impact Level** | ${config.emoji} ${impact} |
            | **Auto-merge Eligible** | ${autoMerge ? 'âœ… Yes' : 'âŒ No'} |
            
            ### ğŸ’¡ Recommendation
            ${recommendation}
            
            ---
            
            <details>
            <summary>ğŸ“– Impact Classification Guide</summary>
            
            | Level | Criteria | Action |
            |-------|----------|--------|
            | ğŸ“¦ POM_ONLY | Only pom.xml changed | Auto-merge âœ… |
            | ğŸŸ¢ TRIVIAL | Docs, tests only, <50 lines | Auto-merge âœ… |
            | ğŸŸ¡ MINOR | 1-4 Java files, 50-200 lines | Review recommended |
            | ğŸŸ  MAJOR | 5-10 Java files, 200-500 lines, or POM + other files | Review required |
            | ğŸ”´ CRITICAL | >10 files, >500 lines, security files | Senior review required |
            
            </details>
            
            ---
            *ğŸ¤– Automated analysis by PR Automation*`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

  auto-merge:
    name: Auto Merge (Trivial Changes)
    runs-on: ubuntu-latest
    needs: [build, analyze-impact]
    if: |
      needs.analyze-impact.outputs.auto_merge == 'true' && 
      needs.build.result == 'success'

    steps:
      - name: Approve PR
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              event: 'APPROVE',
              body: 'âœ… **Auto-approved:** Trivial changes detected. All checks passed.'
            });
            console.log('âœ… PR approved');

      - name: Merge PR
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.pulls.merge({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              merge_method: 'squash',
              commit_title: `Auto-merge: ${context.payload.pull_request.title}`,
              commit_message: 'Automatically merged - trivial changes with passing checks.'
            });
            console.log('ğŸ‰ PR merged');

  add-labels:
    name: Add Labels
    runs-on: ubuntu-latest
    needs: [ensure-labels, analyze-impact]

    steps:
      - name: Add Impact Label
        uses: actions/github-script@v7
        with:
          script: |
            const impact = '${{ needs.analyze-impact.outputs.impact_level }}';
            
            // Map all impact levels to labels
            const labelMap = {
              'CRITICAL': 'impact-critical',
              'MAJOR': 'impact-major',
              'MINOR': 'impact-minor',
              'TRIVIAL': 'impact-trivial',
              'POM_ONLY': 'impact-trivial'  // POM-only updates are low-risk
            };
            
            // Get label or fail safely with a default
            const label = labelMap[impact];
            
            if (!label) {
              console.log(`âš ï¸ Unknown impact level: ${impact}, skipping label assignment`);
              return;
            }
            
            try {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: [label]
              });
              console.log(`âœ… Added label: ${label} (impact: ${impact})`);
            } catch (error) {
              if (error.status === 404) {
                console.log(`âš ï¸ Label '${label}' does not exist. Ensure labels are created.`);
              } else {
                console.log(`âš ï¸ Failed to add label: ${error.message}`);
              }
            }